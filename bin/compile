#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>
# $HOME: /app

# -e - always exit on error
# -o pipefail - don't ignore exit codes when piping output
set -euo pipefail

BUILD_DIR=${1:-.}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}
BP_DIR=$(cd "$(dirname "${0:-}")"; cd ..; pwd)

source "$BP_DIR/common"

HEROKU_DIR=$BUILD_DIR/.scalingo
BIN_DIR=$HEROKU_DIR/bin

# To enable the local source build cache path, copy the files and match the build path with the startup path.
cp -rp $BUILD_DIR $HOME
cd $HOME

# Export the content of the ENV_DIR into the environment
if [ -d "$ENV_DIR" ]; then
  for e in $(ls $ENV_DIR); do
    export "$e=$(cat $ENV_DIR/$e)"
  done
fi

# Allow Bun version pinning via a choice of 3 different files
if [ -f $BUILD_DIR/.bun-version ]
then
  BUN_VERSION="$(cat $BUILD_DIR/.bun-version)"
elif [ -f $BUILD_DIR/runtime.bun.txt ]
then
  BUN_VERSION="$(cat $BUILD_DIR/runtime.bun.txt)"
elif [ -f $BUILD_DIR/runtime.txt ]
then
  BUN_VERSION="$(cat $BUILD_DIR/runtime.txt)"
fi
echo "Installing Bun $BUN_VERSION"

if [[ -n $BUN_VERSION ]]
then
  # prepend a v to version numbers, eg 1.0.19 -> v1.0.19
  if [[ $BUN_VERSION =~ ^[0-9] ]]; then
    BUN_VERSION="v${BUN_VERSION}"
  fi
  BUN_INSTALL_VERSION="-s bun-$BUN_VERSION"
fi

# install bun
export BUN_INSTALL=$BUILD_DIR/.scalingo
export BUN_DIR=$BUILD_DIR/.scalingo/cache
curl -fsSL --retry-connrefused --retry 3 https://bun.sh/install | bash $BUN_INSTALL_VERSION
export PATH="$BUN_INSTALL/bin:$PATH"

# set environment variables at runtime
PROFILE_PATH="$BUILD_DIR/.profile.d/bun.sh"
mkdir -p $(dirname $PROFILE_PATH)
echo 'export PATH="$HOME/.scalingo/bin:$PATH"' >> $PROFILE_PATH
echo 'export BUN_DIR="$HOME/.scalingo/cache"' >> $PROFILE_PATH

# export environment variables to subsequent buildpacks
echo "export PATH=\"$BUILD_DIR/.scalingo/bin:\$PATH\"" >> "$BP_DIR/export"
echo "export BUN_DIR=\"$BUILD_DIR/.scalingo/cache\"" >> "$BP_DIR/export"

echo "Installed Bun v$(bun --version)"

set +e

cd $BUILD_DIR

# download dependencies
if [[ -f package.json && ! -f .skip-bun-install ]]
then
  echo "Installing dependencies..."
  bun install
fi

has_scalingo_prebuild_script=$(has_script "package.json" "scalingo-prebuild")
if [[ "$has_scalingo_prebuild_script" == "true" && ! -f .skip-bun-scalingo-prebuild ]]
then
  echo "Running Scalingo prebuild script..."
  bun run scalingo-prebuild
fi

has_build_script=$(has_script "package.json" "build")
if [[ "$has_build_script" == "true" && ! -f .skip-bun-build ]]
then
  echo "Building application..."
  bun run build
  echo "Done building application..."
fi

has_scalingo_postbuild_script=$(has_script "package.json" "scalingo-postbuild")
if [[ "$has_scalingo_postbuild_script" == "true" && ! -f .skip-bun-scalingo-postbuild ]]
then
  echo "Running Scalingo postbuild script..."
  bun run scalingo-postbuild
fi
